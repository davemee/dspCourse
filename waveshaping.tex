\chapter{Sampling, Waveshaping, und nicht Linearität}
\label{Waveshaping}

\begin{center}
\begin{figure}[h!]
\tikzset{concept/.append style={fill={none}}}
\begin{tikzpicture}
  \path[mindmap,concept color=black,text=black]
    node[concept] {Sampling}
    [clockwise from=0]
    child[concept color=red!50!black] {node[concept] (rec) {recording} }
    child[concept color=green!80!black] {node[concept] (pla) {playback} }
    %   [clockwise from=90]
    %   child { node[concept] {algorithms} }
    %   child { node[concept] {data structures} }
    %   child { node[concept] {pro\-gramming languages} }
    %   child { node[concept] {software engineer\-ing} }
    % }
    child[concept color=blue] { node[concept] (ram) {in RAM vs. from Disk}[clockwise from=-30]}
    child[concept color=red] { node[concept] (gra) {granular} }
    child[concept color=orange] { node[concept] {Waveshaping and Distortion} };

\begin{pgfonlayer}{background}
	% \draw [draw=green,fill=black, decorate,decoration=circle connection bar]
    \draw [circle connection bar]
    % \path (rec) to[circle connection bar] (pla)
      (rec) edge (pla)
      (gra) edge (pla)
      (ram) edge (pla)
      ;
  \end{pgfonlayer}

\end{tikzpicture}
\caption{Lecture Contents}
\end{figure}
\end{center}

\section{Notizen}

Waveshaping generell.

Evt. Subtraktiver Synth am ende.

Zusammenhang waveshaping, distortion. lookup table, sampling, wavescanning.

Waveshaping = modulation \cite[p.~257]{farnell_designing_2010}

chebyshev

\glqq{}intermod. distortion \grqq{} , vgl. miller puckette, \\
http://msp.ucsd.edu/techniques/latest/book-html/node78.html

middle term! ( (a+b)**2 = a**2 +2ab +b**2 )




beispiele:
sinus
vllt:\\
dyn. non-linear functions




\section{Uebersicht}
Zunächst: Sampling, dann lineare transfer function.

\begin{enumerate}
	\item übersicht: fragen wies geht, wie ist es mit Max/MSP?
	\item HÜ ankündigen
	\item neue abstraction: z-1
	\item Raetsel
	\item Wo letztes mal stehngeblieben? Poly syth fertig?
	\item linearität erklären. Nun Nichtlinearität.
	\item wavetable/lookup wiederholung
	\item Lookup als waveshaping/distortion
	\item waveshaping durch processing vs. durch lookuptable
	\item durchrechnen
	\item chebyshev
	\item Sampling (Ram nicht Ram)
	\item send and receive von GUI f. Hausübung
\end{enumerate}

\section{Waveshaping}
Wikipedia quote, page ``wavesahper'':\\
\glqq{}The mathematics of non-linear operations on audio signals is difficult, and not well understood.\grqq{}
Waveshaping means distortion. It add overtones, take a look at figure ~\ref{fig:waveshapedSIne}.


\begin{figure}[h!]
	\centering
	\includegraphics[width=11cm]{waveShapedSine.png}
	\caption[Wave shaped sine oscillator]
	{A sine wave has been generated and waveshaping was applied to add overtones.}
	\label{fig:waveshapedSIne}
\end{figure}


\subsection{The simples case: a linear Transfer function. } % (fold)
\label{sub:linearTrans}
See \ref{fig:linfunct}. A linear transfer function is used as a lookup table for a sinosoidal input.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale = 1]{img/waveShapingVisual.png}
		\caption{Linear Transfer function}
		\label{fig:linfunct}
	\end{center}
\end{figure}
A transfer function in the sense of a waveshaper (a ``transfer function'' might also mean frequency response in other contexts) is a simple look-up function. \
Waveshaping means to use an input wave \textit{look up} values in a table or function. A linear transfer function, let's call it $l$, results in no change, since, by definition, it returns $l(x)=x$. \
This means, that whatever value we pass in, we get the same value out.\
Non-liner transfer functions behave differently. They map they input to other values, such as $f(x) = x^2$. It may seem trivial, but if we put 2 into $f$ we get 4 as an output. If we now plot this function we get:

\begin{figure}[H]
	\begin{center}
		\includegraphics[width = 14cm]{img/squareFunction.png}
		\caption{The function $f(x)=x^2$}
		\label{fig:square}
	\end{center}
\end{figure}

% subsection subsection_name (end)




\subsection{Simple non-linearity: \(X ^2\)} % (fold)
\label{sub:nonLinearTrans}

A 2nd order polynomial shall be analyzed. The function

\begin{equation}
f(x) = x ^ 2
\end{equation}
 is used and also plotted in figure \ref{fig:square}.\\


% \fbox{
%   \parbox{\textwidth}{
%     Ein polynom geradzahliger ordnung \(n\) als Transferfunktion produziert immer alle geradzahligen obertöne von \(n\) bis 0, exklusive der grundfrequenz (da ja auch ungerade, 1 ist eine ungerade zahl).\\
% Ein polynom ungeradzahliger ordnung \(n\) als Transferfunktion produziert immer alle ungeradzahligen obertöne von \(n\) bis 1, also der grundfrequenz.
%   }
% }
We can simply plot what happened is we apply the function before trying to understand analytically:


\begin{figure}[H]
	\begin{center}
		\includegraphics[width = 14cm]{img/sinSquared.png}
		\caption{Applying the square function to an input sine wave.}
		\label{fig:sinSquared}
	\end{center}
\end{figure}


Weird, the input seems to double in frequency. Let's try to understand what's happening.\

So we calculate what happens if we send a cosine through this function, so let's take:

\begin{equation}
x = cos(\omega)
\end{equation}
wit arbitrary $\omega$. We can just ignore $\omega$ here for a while. Usually, there should be some indexing variable in the cosine function if we want to describe an oscillator that moves over time, but let's also skip that.\\
So applying our square function we of course get:
\begin{equation}
y = cos(\omega)^2
\end{equation}
This again results in:
\begin{equation}
y = cos(\omega) \cdot cos(\omega)
\end{equation}
So far so trivial. Note that a multiplication of two oscillators is called \textit{Amplitude Modulation} (actually, in this case we encounter ``Ring Modulation'', but let's ignore that also), and we know things about Amplitude modulation, namely:\

\fbox{
  \parbox{\textwidth}{
  When multiplying two oscillators, we get sum and difference of the two input frequencies. (And the whole output is attenuated by 6dB)
  }}
The above statement in equation form:
\begin{equation}
	cos(a)\cdot cos(b) = \frac{cos(a+b) + cos(a-b)}{2}
\end{equation}

We could also have looked up this \textit{trigonometric identity}.
This means for our experiment with our cosine squared:

\begin{equation}
y = \frac{cos(\omega+\omega) + cos(\omega-\omega)}{2}
\end{equation}
So:
\begin{equation}
y = \frac{cos(2 \cdot \omega) + cos(0)}{2} = \frac{cos(2 \cdot \omega )}{2}+\frac{1}{2}
\end{equation}

We arrive at the same result!
\textbf{But is this true for every input? That would mean we just built a frequency shofter, did we? No.} Waveshaping is much more complicated, which is immediately obvious when we try to do the same t two oscillators:
\begin{equation}
x = cos(\omega_1)+cos(\omega_2)
\end{equation}
then
\begin{equation}
y = (cos(\omega_1)+cos(\omega_2) ) ^2
\end{equation}
\begin{equation}
y = cos(\omega_1)^2+cos(\omega_2)^2+2\cdot cos(\omega_1) \cdot cos(\omega_2)
\end{equation}

And finally:
\begin{equation}
	y = \frac{cos(2 \cdot \omega_1)}{2} + \frac{1}{2} + \frac{cos(2 \cdot \omega_2)}{2} +\frac{1}{2} + 2 \cdot (\frac{cos(\omega_1+\omega_2) + cos(\omega_1-\omega_2)}{2})
\end{equation}



\subsection{How is Waveshaping related to other techniques?}
\subsubsection{Sampling}
If we take a look at figure \ref{fig:RamFilePlayback}, we see that we play a sound file by accessing a buffer (wavetable) using an index, an oscillator. This is effectively the same setup as we would build for distorting an input sound. Also take a look at figure \ref{fig:identity}, which showing us that waveshaping and wavetable synthesis are identical.

\begin{figure}[H]
	\centering
	\includegraphics[width=11cm]{identityWaveshaping.png}
	\caption[farnell waveshaping identity]
	{Picture taken from \cite{farnell_designing_2010}, showing the identity of waveshaping and wavetable synthesis}
	\label{fig:identity}
\end{figure}



\subsubsection{Modulation}
While we will talk about modulation in a separate chapter, let's loosely define amplitude modulation (AM) as the multiplication od two oscillators and frequency modulation (FM) as the varying the frequency of an oscilator using another oscillator.\
So, as we have also seen above, AM looks like this:
\begin{equation}
	y = sin(a)\cdot sin(b)
\end{equation}

and FM looks like this:

\begin{equation}
	y = sin(sin(a))
\end{equation}

in practice, the a and b terms are a bit more complicated, but we will look at this later. That certain cases of AM are identical to waveshaping has been shown above, think about the square function again. 
This of course does not mean that waveshaping can do everything AM can do and it does not mean that AM can achieve everything that waveshaping can. This should just show that we can understand the techniques from the perspective of another.\
What about FM? Well if our lookup function we use for waveshaping is a sine wave, we arrive at the exact same equation as how we defined FM above. Again, practically speaking, the results we get with these two techniques are very different, but we can see the connections.


\subsection{Why is Waveshaping useful?}
The output spectrum is dependent on the input amplitude. This makes it easy to create complex evolving spectra.

\subsection{What are the problems with waveshaping?}

Waveshaping adds overtones. When we build a waveshaper, we have to be aware of aliasing. Take a look at figures ~\ref{fig:clipped1} and ~\ref{fig:clipped2}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=11cm]{clippedSine.png}
	\caption[clipped sine wave]
	{A sine wave was generated and clipped. Clipping is a form of waveshaping which adds many overtones. Note how high frequencies fold back into the lower parts of the spectrum because they exceed the Nyquist-rate.}
	\label{fig:clipped1}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=11cm]{clippedSine2.png}
	\caption[clipped sine wave 2]
	{Again, a sine wave, this time with a higher frequency to begin with. Extreme clipping has been applied by boosting the input amplitude. The aliased overtones are all over the place, even below the input frequency.}
	\label{fig:clipped2}
\end{figure}

The problem of aliasing is usually treated by over-sampling. This does not solve the problem but lessens it significantly resulting in cleaner, arguably better sound. Oversampling means that, if we work at a sample-rate of 44.1kHz, the input is up-sampled, essentially interpolated, to be at a sample-rate of 88.2kHz. Then the waveshaping is applied, leaving room for high frequencies up to 44.1kHz. Using a lowpass filter, high frequencies over 22.1kHz are then attenuated as much as possible, in order to be able to down-sample again to reach our initial sample-rate of 44.1kHz. \\
To state it more simple: Waveshaping is usually encapsulated in a process that runs at higher sampling rates in order to lessen aliasing. 


% Wieso ist waveshaping praktisch? Amplitudenabhängigkeit d. spectrums.
% Wieso ist waveshaping verwandt mit modulation, sowohl FM, PM als auch AM? Am: siehe \(x^2\). FM: siehe \(f(x)=cos(x)\). Auch kann letztendlich eine transferkuntion in cos/sin bestandteile zerlegt werden um zu einer menge an frequenzmodulationen anzukommen, bzw kann der wavetable als polynom angenähert(o. Taylor entwicklung) werden um bei AM anzukommen.



\section{Sampler}

\textit{Work in progress.}

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale = 1]{img/sampler.png}
		\caption{simpleSampler}
		\label{fig:simpleSampler}
	\end{center}
\end{figure}

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale = 1]{img/soundFileToRam.png}
		\caption{sound in Ram}
		\label{fig:soundRam}
	\end{center}
\end{figure}


\begin{figure}[H]
	\begin{center}
		\includegraphics[scale = 1]{img/RamFilePlayback.png}
		\caption{RamFilePlayback}
		\label{fig:RamFilePlayback}
	\end{center}
\end{figure}



\begin{figure}[H]
	\begin{center}
		\includegraphics[width = 14cm]{writingAudio.png}
		\caption{writing Audio to disk}
		\label{fig:writing}
	\end{center}
\end{figure}


\begin{figure}[H]
	\begin{center}
		\includegraphics[scale = 0.6]{img/grain.png}
		\caption{moreSamplimg.pd, a simplified version of granular sampling}
		\label{fig:name}
	\end{center}
\end{figure}



\section{Hausübung}
\subsection{Testmodul}

baue ein audio Testmodul mit folgener spezifikation:\\
\begin{itemize}
	\item Ein audio output
	\item verschiedene klangquellen wählbar:
		\begin{enumerate}
			\item White Noise
			\item Sinus (freq. einstellbar)
			\item soundfile (file wählbar)
		\end{enumerate}
	\item GUI
	\item verfügbar(in eurem pfad, und jederzeit abrufbar als abstraction)
	\item output pegel sichtbar (level meter)
\end{itemize}


\begin{figure}[H]
	\begin{center}
		\includegraphics[scale = 1]{img/audioTester.png}
		\caption{audioTester.pd, zu bauen als Hausübung}
		\label{fig:audiotester}
	\end{center}
\end{figure}

